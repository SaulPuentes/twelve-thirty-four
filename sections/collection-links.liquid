{%- liquid
  assign columns = section.blocks.size
  if columns == 0
    assign columns = 3
  endif
-%}

<section
  id="CollectionLinks-{{ section.id }}"
  class="collection-links"
  style="--collection-links-columns: {{ columns }};"
>
  <div class="collection-links__grid">
    {%- for block in section.blocks -%}
      {%- liquid
        assign link_type = block.settings.link_type | default: 'custom'
        assign is_product = false
        assign item_link = block.settings.link | default: '#'
        assign item_title = block.settings.title | default: 'Collection'
        assign item_image = block.settings.image
        assign product_title = ''
        assign product_price = ''
        assign selected_product = block.settings.product

        if link_type == 'product' and selected_product != blank
          assign is_product = true
          assign item_link = selected_product.url
          assign item_title = block.settings.title | default: selected_product.title
          assign product_title = block.settings.product_title | default: selected_product.title
          assign product_price = selected_product.price | money

          if item_image == blank and selected_product.featured_media != blank
            assign item_image = selected_product.featured_media
          endif
        endif
      -%}

      <a
        href="{{ item_link }}"
        class="collection-links__item{% if is_product %} collection-links__item--product{% endif %}"
        {{ block.shopify_attributes }}
        {% if block.settings.open_new_tab %}target="_blank" rel="noopener"{% endif %}
      >
        <div class="collection-links__media">
          {%- if item_image != blank -%}
            <img
              src="{{ item_image | image_url: width: 1200 }}"
              alt="{{ item_image.alt | default: item_title | escape }}"
              width="600"
              height="{{ 600 | divided_by: item_image.aspect_ratio | round }}"
              class="collection-links__image"
              loading="lazy"
            >
          {%- else -%}
            {{ 'collection-' | append: forloop.index | placeholder_svg_tag: 'collection-links__placeholder' }}
          {%- endif -%}
          <div class="collection-links__overlay"></div>
        </div>

        <div class="collection-links__content">
          <span class="collection-links__label">{{ item_title }}</span>
        </div>

        {%- if is_product -%}
          <div class="collection-links__product">
            <div class="collection-links__product-info">
              <h3 class="collection-links__product-title">{{ product_title }}</h3>
              <p class="collection-links__product-price">{{ product_price }}</p>
            </div>
            {%- if block.settings.show_add_to_cart -%}
              {%- if selected_product.available -%}
                <button
                  type="button"
                  class="collection-links__add-to-cart"
                  data-variant-id="{{ selected_product.selected_or_first_available_variant.id }}"
                  aria-label="{{ 'products.product.add_to_cart' | t }}"
                >
                  <span class="collection-links__add-to-cart-text">Add to Cart</span>
                  <span class="collection-links__add-to-cart-loading" aria-hidden="true">Adding...</span>
                  <span class="collection-links__add-to-cart-added" aria-hidden="true">Added!</span>
                </button>
              {%- else -%}
                <span class="collection-links__sold-out">Sold Out</span>
              {%- endif -%}
            {%- endif -%}
          </div>
        {%- endif -%}
      </a>
    {%- else -%}
      {%- for i in (1..3) -%}
        <div class="collection-links__item collection-links__item--placeholder">
          <div class="collection-links__media">
            {{ 'collection-' | append: i | placeholder_svg_tag: 'collection-links__placeholder' }}
            <div class="collection-links__overlay"></div>
          </div>
          <div class="collection-links__content">
            <span class="collection-links__label">Collection {{ i }}</span>
          </div>
        </div>
      {%- endfor -%}
    {%- endfor -%}
  </div>
</section>

{% stylesheet %}
  .collection-links {
    width: 100%;
  }

  .collection-links__grid {
    display: grid;
    grid-template-columns: 1fr;
  }

  @media screen and (min-width: 750px) {
    .collection-links__grid {
      grid-template-columns: repeat(var(--collection-links-columns, 3), 1fr);
    }
  }

  .collection-links__item {
    position: relative;
    aspect-ratio: 3 / 4;
    overflow: hidden;
    display: block;
    text-decoration: none;
    color: #fff;
  }

  @media screen and (min-width: 750px) {
    .collection-links__item {
      aspect-ratio: 1 / 1;
    }
    
    .collection-links__grid[style*="--collection-links-columns: 3"] .collection-links__item {
      aspect-ratio: 3 / 4;
    }
  }

  .collection-links__media {
    position: absolute;
    inset: 0;
  }

  .collection-links__image,
  .collection-links__placeholder {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .collection-links__item:hover .collection-links__image {
    transform: scale(1.05);
  }

  .collection-links__overlay {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s ease;
  }

  .collection-links__item:hover .collection-links__overlay {
    background-color: rgba(0, 0, 0, 0.3);
  }

  .collection-links__content {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 2rem 2.5rem;
    z-index: 10;
  }

  .collection-links__label {
    font-family: var(--font-body-family);
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    transition: opacity 0.3s ease;
  }

  .collection-links__item:hover .collection-links__label {
    opacity: 0.8;
  }

  .collection-links__product {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2rem 2.5rem;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    transform: translateY(100%);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  /* Always show on mobile */
  @media screen and (max-width: 749px) {
    .collection-links__product {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .collection-links__item:hover .collection-links__product {
    transform: translateY(0);
    opacity: 1;
  }

  .collection-links__product-info {
    flex: 1;
  }

  .collection-links__product-title {
    font-family: var(--font-body-family);
    font-size: 0.875rem;
    font-weight: 400;
    margin: 0 0 0.5rem;
    line-height: 1.4;
  }

  .collection-links__product-price {
    font-family: var(--font-body-family);
    font-size: 0.875rem;
    margin: 0;
    opacity: 0.9;
  }

  .collection-links__add-to-cart {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid #fff;
    color: #fff;
    font-family: var(--font-body-family);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    white-space: nowrap;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .collection-links__add-to-cart:hover {
    background-color: #fff;
    color: #111;
  }

  .collection-links__add-to-cart:disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }

  .collection-links__add-to-cart-loading,
  .collection-links__add-to-cart-added {
    display: none;
  }

  .collection-links__add-to-cart[data-loading="true"] .collection-links__add-to-cart-text {
    display: none;
  }

  .collection-links__add-to-cart[data-loading="true"] .collection-links__add-to-cart-loading {
    display: inline;
  }

  .collection-links__add-to-cart[data-added="true"] .collection-links__add-to-cart-text {
    display: none;
  }

  .collection-links__add-to-cart[data-added="true"] .collection-links__add-to-cart-added {
    display: inline;
  }

  .collection-links__sold-out {
    padding: 0.5rem 1rem;
    font-family: var(--font-body-family);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    opacity: 0.7;
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    const section = document.getElementById('CollectionLinks-{{ section.id }}');
    if (!section) return;

    // Use capture phase to intercept click before anchor processes it
    section.addEventListener('click', async function(event) {
      const button = event.target.closest('.collection-links__add-to-cart');
      if (!button) return;

      // Stop the event from reaching the anchor tag
      event.preventDefault();
      event.stopImmediatePropagation();

      const variantId = button.dataset.variantId;
      if (!variantId || button.disabled) return;

      // Disable button and show loading state
      button.disabled = true;
      button.dataset.loading = 'true';
      button.removeAttribute('data-added');

      try {
        // Use the global cart handler
        if (window.cart && typeof window.cart.addItem === 'function') {
          await window.cart.addItem(parseInt(variantId, 10), 1);
        } else {
          // Fallback: Direct API call
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              items: [{ id: parseInt(variantId, 10), quantity: 1 }]
            })
          });

          if (!response.ok) {
            throw new Error('Failed to add item to cart');
          }

          // Update cart count
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          document.querySelectorAll('[data-cart-count]').forEach(el => {
            el.textContent = cart.item_count;
            el.classList.toggle('hidden', cart.item_count === 0);
          });
        }

        // Show success state
        button.removeAttribute('data-loading');
        button.dataset.added = 'true';

        // Reset after 2 seconds
        setTimeout(() => {
          button.removeAttribute('data-added');
          button.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('Error adding to cart:', error);
        button.removeAttribute('data-loading');
        button.disabled = false;
      }
    }, true); // Use capture phase

    // Also prevent anchor clicks when clicking button area
    section.querySelectorAll('.collection-links__add-to-cart').forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault();
        event.stopPropagation();
      });
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Collection links",
  "tag": "section",
  "class": "section-collection-links",
  "settings": [],
  "blocks": [
    {
      "type": "collection_link",
      "name": "Collection link",
      "settings": [
        {
          "type": "select",
          "id": "link_type",
          "label": "Link type",
          "options": [
            { "value": "custom", "label": "Custom link" },
            { "value": "product", "label": "Product" }
          ],
          "default": "custom"
        },
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Select a product when using Product link type"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Overrides product image if set"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Collection name",
          "info": "Label shown at the top of the card. Defaults to product title if not set."
        },
        {
          "type": "text",
          "id": "product_title",
          "label": "Product title override",
          "info": "Overrides the product name shown in the overlay (product link type only)"
        },
        {
          "type": "header",
          "content": "Custom link"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link URL",
          "info": "For custom link type only"
        },
        {
          "type": "checkbox",
          "id": "open_new_tab",
          "label": "Open in new tab",
          "default": false
        },
        {
          "type": "header",
          "content": "Options"
        },
        {
          "type": "checkbox",
          "id": "show_add_to_cart",
          "label": "Show add to cart button",
          "default": true,
          "info": "Product link type only"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collection links",
      "blocks": [
        {
          "type": "collection_link",
          "settings": {
            "title": "Bury Me West",
            "link_type": "custom"
          }
        },
        {
          "type": "collection_link",
          "settings": {
            "title": "Elizabeth Hooper Studio",
            "link_type": "custom"
          }
        },
        {
          "type": "collection_link",
          "settings": {
            "title": "Chase Gamblin",
            "link_type": "custom"
          }
        }
      ]
    }
  ]
}
{% endschema %}
