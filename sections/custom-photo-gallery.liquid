{%- comment -%}
  Custom Photo Gallery Section
  A responsive grid gallery
  Desktop: 3-column layout with asymmetric spans
  Tablet: 2-column layout
  Mobile: 1-column layout
{%- endcomment -%}

{%- liquid
  assign section_id = section.id
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign grid_gap = section.settings.grid_gap
  assign border_radius = section.settings.border_radius
  assign left_link_url = section.settings.left_link_url
  assign left_link_text = section.settings.left_link_text
  assign right_link_url = section.settings.right_link_url
  assign right_link_text = section.settings.right_link_text
  assign enable_slideshow = section.settings.enable_slideshow
-%}

<section
  id="PhotoGallery-{{ section_id }}"
  class="photo-gallery"
  style="
    --gallery-gap: {{ grid_gap }}px;
    --gallery-border-radius: {{ border_radius }}px;
    --gallery-card-height: {{ section.settings.card_height }}px;
    --gallery-card-height-mobile: {{ section.settings.card_height_mobile }}px;
  "
>
  <div class="page-width">
    <div class="photo-gallery__container">
      {%- if heading != blank or subheading != blank -%}
        <header class="photo-gallery__header">
          {%- if heading != blank -%}
            <h2 class="photo-gallery__heading">{{ heading }}</h2>
          {%- endif -%}
          {%- if subheading != blank -%}
            <p class="photo-gallery__subheading">{{ subheading }}</p>
          {%- endif -%}
        </header>
      {%- endif -%}

      <div class="photo-gallery__grid">
      {%- if section.blocks.size > 0 -%}
        {%- for block in section.blocks -%}
          {%- liquid
            assign image = block.settings.image
            assign link = block.settings.link
            assign alt_text = block.settings.alt_text
            assign size = block.settings.size | default: 'standard'
          -%}

          <div class="photo-gallery__item{% if size == 'large' %} photo-gallery__item--large{% elsif size == 'double' %} photo-gallery__item--double{% endif %}" {{ block.shopify_attributes }}>
            {%- if enable_slideshow and image != blank -%}
              <button
                type="button"
                class="photo-gallery__slideshow-trigger"
                data-slide-index="{{ forloop.index0 }}"
                data-gallery-id="{{ section_id }}"
                aria-label="Open slideshow at image {{ forloop.index }}"
              >
            {%- elsif link != blank -%}
              <a href="{{ link }}" class="photo-gallery__link">
            {%- endif -%}

            {%- if image != blank -%}
              <img
                src="{{ image | image_url: width: 1200 }}"
                srcset="
                  {{ image | image_url: width: 600 }} 600w,
                  {{ image | image_url: width: 900 }} 900w,
                  {{ image | image_url: width: 1200 }} 1200w,
                  {{ image | image_url: width: 1600 }} 1600w
                "
                sizes="(max-width: 480px) 100vw, (max-width: 768px) 50vw, 33vw"
                alt="{{ alt_text | default: image.alt | escape }}"
                loading="lazy"
                width="{{ image.width }}"
                height="{{ image.height }}"
                class="photo-gallery__image"
              >
            {%- else -%}
              {{ 'image' | placeholder_svg_tag: 'photo-gallery__placeholder' }}
            {%- endif -%}

            {%- if enable_slideshow and image != blank -%}
              </button>
            {%- elsif link != blank -%}
              </a>
            {%- endif -%}
          </div>
        {%- endfor -%}
      {%- else -%}
        {%- comment -%} Placeholder items when no blocks are added {%- endcomment -%}
        {%- for i in (1..7) -%}
          <div class="photo-gallery__item photo-gallery__item--placeholder">
            {{ 'lifestyle-' | append: i | placeholder_svg_tag: 'photo-gallery__placeholder' }}
          </div>
        {%- endfor -%}
      {%- endif -%}
      </div>

      {%- if enable_slideshow -%}
        <div
          class="photo-gallery__lightbox"
          id="PhotoGalleryLightbox-{{ section_id }}"
          role="dialog"
          aria-modal="true"
          aria-label="Image slideshow"
          hidden
        >
          <div class="photo-gallery__lightbox-backdrop"></div>

          <button type="button" class="photo-gallery__lightbox-close" aria-label="Close slideshow">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>

          <button type="button" class="photo-gallery__lightbox-arrow photo-gallery__lightbox-arrow--prev" aria-label="Previous image">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="13 16 7 10 13 4"></polyline>
            </svg>
          </button>

          <button type="button" class="photo-gallery__lightbox-arrow photo-gallery__lightbox-arrow--next" aria-label="Next image">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="7 4 13 10 7 16"></polyline>
            </svg>
          </button>

          <div class="photo-gallery__lightbox-main">
            <img src="" alt="" class="photo-gallery__lightbox-image" />
          </div>

          <div class="photo-gallery__lightbox-thumbs">
            <div class="photo-gallery__lightbox-thumbs-track">
              {%- for block in section.blocks -%}
                {%- if block.settings.image != blank -%}
                  <button
                    type="button"
                    class="photo-gallery__lightbox-thumb"
                    data-thumb-index="{{ forloop.index0 }}"
                    aria-label="Go to image {{ forloop.index }}"
                  >
                    <img
                      src="{{ block.settings.image | image_url: width: 120 }}"
                      alt="{{ block.settings.alt_text | default: block.settings.image.alt | escape }}"
                      loading="lazy"
                      width="80"
                      height="60"
                    >
                  </button>
                {%- endif -%}
              {%- endfor -%}
            </div>
          </div>
        </div>

        <script>
          (function() {
            const sectionId = {{ section_id | json }};
            const lightbox = document.getElementById('PhotoGalleryLightbox-' + sectionId);
            if (!lightbox) return;

            const images = [
              {%- for block in section.blocks -%}
                {%- if block.settings.image != blank -%}
                  {
                    src: {{ block.settings.image | image_url: width: 1800 | json }},
                    alt: {{ block.settings.alt_text | default: block.settings.image.alt | json }}
                  },
                {%- endif -%}
              {%- endfor -%}
            ];

            if (images.length === 0) return;

            const mainImg = lightbox.querySelector('.photo-gallery__lightbox-image');
            const thumbs = lightbox.querySelectorAll('.photo-gallery__lightbox-thumb');
            const prevBtn = lightbox.querySelector('.photo-gallery__lightbox-arrow--prev');
            const nextBtn = lightbox.querySelector('.photo-gallery__lightbox-arrow--next');
            const closeBtn = lightbox.querySelector('.photo-gallery__lightbox-close');
            const backdrop = lightbox.querySelector('.photo-gallery__lightbox-backdrop');
            let current = 0;
            let previouslyFocused = null;

            function show(index) {
              current = (index + images.length) % images.length;
              mainImg.src = images[current].src;
              mainImg.alt = images[current].alt || '';
              thumbs.forEach(function(t, i) {
                t.classList.toggle('photo-gallery__lightbox-thumb--active', i === current);
              });
              scrollThumbIntoView(current);
            }

            function scrollThumbIntoView(index) {
              const thumb = thumbs[index];
              if (thumb) {
                thumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
              }
            }

            function open(index) {
              previouslyFocused = document.activeElement;
              show(index);
              lightbox.hidden = false;
              document.body.style.overflow = 'hidden';
              requestAnimationFrame(function() {
                lightbox.classList.add('photo-gallery__lightbox--open');
              });
              closeBtn.focus();
            }

            function close() {
              lightbox.classList.remove('photo-gallery__lightbox--open');
              lightbox.addEventListener('transitionend', function handler() {
                lightbox.hidden = true;
                document.body.style.overflow = '';
                if (previouslyFocused) previouslyFocused.focus();
                lightbox.removeEventListener('transitionend', handler);
              }, { once: true });
            }

            document.querySelectorAll('[data-gallery-id="' + sectionId + '"]').forEach(function(trigger) {
              trigger.addEventListener('click', function() {
                open(parseInt(this.dataset.slideIndex, 10));
              });
            });

            prevBtn.addEventListener('click', function() { show(current - 1); });
            nextBtn.addEventListener('click', function() { show(current + 1); });
            closeBtn.addEventListener('click', close);
            backdrop.addEventListener('click', close);

            thumbs.forEach(function(thumb) {
              thumb.addEventListener('click', function() {
                show(parseInt(this.dataset.thumbIndex, 10));
              });
            });

            lightbox.addEventListener('keydown', function(e) {
              if (e.key === 'Escape') close();
              if (e.key === 'ArrowLeft') show(current - 1);
              if (e.key === 'ArrowRight') show(current + 1);
            });
          })();
        </script>
      {%- endif -%}

      {%- if left_link_url != blank or right_link_url != blank -%}
        <nav class="photo-gallery__links" aria-label="Custom links">
          {%- if left_link_url != blank -%}
            <a href="{{ left_link_url }}" class="photo-gallery__link-item">{{ left_link_text | default: 'Left link' }}</a>
          {%- endif -%}
          {%- if right_link_url != blank -%}
            <a href="{{ right_link_url }}" class="photo-gallery__link-item">{{ right_link_text | default: 'Right link' }}</a>
          {%- endif -%}
        </nav>
      {%- endif -%}
    </div>
  </div>
</section>

{% stylesheet %}
  .photo-gallery {
    padding: 3rem 1rem;
    background-color: var(--color-background, #fff);
  }

  @media screen and (min-width: 750px) {
    .photo-gallery {
      padding: 4rem 2rem;
    }
  }

  @media screen and (min-width: 990px) {
    .photo-gallery {
      padding: 5rem 3rem;
    }
  }

  .photo-gallery__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 2rem;
    gap: 1rem;
  }

  @media screen and (max-width: 749px) {
    .photo-gallery__header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.625rem;
    }
  }

  @media screen and (min-width: 750px) {
    .photo-gallery__header {
      margin-bottom: 3rem;
    }
  }

  .photo-gallery__heading {
    font-family: var(--font-heading-family);
    font-size: 1.75rem;
    font-weight: var(--font-heading-weight, 400);
    line-height: 1.2;
    margin: 0;
    color: var(--color-foreground);
  }

  @media screen and (min-width: 750px) {
    .photo-gallery__heading {
      font-size: 2.25rem;
    }
  }

  @media screen and (min-width: 990px) {
    .photo-gallery__heading {
      font-size: 2.5rem;
    }
  }

  .photo-gallery__subheading {
    font-family: var(--font-body-family);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin: 0;
    color: var(--color-foreground);
    opacity: 0.75;
    max-width: 500px;
  }

  @media screen and (min-width: 750px) {
    .photo-gallery__subheading {
      font-size: 1rem;
    }
  }

  .photo-gallery__container {
    max-width: 1600px;
    margin: 0 auto;
  }

  .photo-gallery__grid {
    display: grid;
    grid-template-columns: 1fr;
    grid-auto-rows: var(--gallery-card-height-mobile, 280px);
    grid-auto-flow: dense;
    gap: var(--gallery-gap, 20px);
  }

  /* Tablet: 2 columns */
  @media screen and (min-width: 481px) {
    .photo-gallery__grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .photo-gallery__item--large {
      grid-column: span 2;
    }

    .photo-gallery__item--double {
      grid-column: span 2;
      grid-row: span 2;
    }
  }

  /* Desktop: 3 columns */
  @media screen and (min-width: 769px) {
    .photo-gallery__grid {
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: var(--gallery-card-height, 360px);
    }

    .photo-gallery__item--large {
      grid-column: span 2;
    }

    .photo-gallery__item--double {
      grid-column: span 2;
      grid-row: span 2;
    }
  }

  .photo-gallery__item {
    position: relative;
    overflow: hidden;
    border-radius: var(--gallery-border-radius, 16px);
    background-color: #f5f5f5;
    opacity: 0;
    animation: fadeInUp 0.6s ease-out both;
  }

  /* Staggered animation for items */
  .photo-gallery__item:nth-child(1) {
    animation-delay: 0.05s;
  }

  .photo-gallery__item:nth-child(2) {
    animation-delay: 0.1s;
  }

  .photo-gallery__item:nth-child(3) {
    animation-delay: 0.15s;
  }

  .photo-gallery__item:nth-child(4) {
    animation-delay: 0.2s;
  }

  .photo-gallery__item:nth-child(5) {
    animation-delay: 0.25s;
  }

  .photo-gallery__item:nth-child(6) {
    animation-delay: 0.3s;
  }

  .photo-gallery__item:nth-child(7),
  .photo-gallery__item:nth-child(n+8) {
    animation-delay: 0.35s;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .photo-gallery__link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .photo-gallery__image,
  .photo-gallery__placeholder {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .photo-gallery__link:hover .photo-gallery__image {
    transform: scale(1.05);
  }

  .photo-gallery__placeholder {
    fill: #999;
    background-color: #e8e8e8;
  }

  .photo-gallery__links {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(var(--color-foreground-rgb, 0, 0, 0), 0.1);
  }

  @media screen and (min-width: 750px) {
    .photo-gallery__links {
      margin-top: 3rem;
      padding-top: 2rem;
    }
  }

  .photo-gallery__link-item {
    font-family: var(--font-body-family);
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-foreground);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
  }

  .photo-gallery__link-item:hover {
    border-bottom-color: currentColor;
  }

  /* Slideshow trigger button */
  .photo-gallery__slideshow-trigger {
    display: block;
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    border: 0;
    background: none;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
  }

  .photo-gallery__slideshow-trigger:hover .photo-gallery__image {
    transform: scale(1.05);
  }

  /* Lightbox overlay */
  .photo-gallery__lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .photo-gallery__lightbox:not([hidden]) {
    display: flex;
  }

  .photo-gallery__lightbox--open {
    opacity: 1;
  }

  .photo-gallery__lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.88);
  }

  /* Close button */
  .photo-gallery__lightbox-close {
    position: absolute;
    top: 1.25rem;
    right: 1.25rem;
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    padding: 0;
    border: 0;
    border-radius: 50%;
    background: transparent;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .photo-gallery__lightbox-close:hover {
    color: #fff;
  }

  /* Navigation arrows */
  .photo-gallery__lightbox-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(calc(-50% - 30px));
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    padding: 0;
    border: 0;
    border-radius: 50%;
    background: transparent;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .photo-gallery__lightbox-arrow:hover {
    color: #fff;
  }

  .photo-gallery__lightbox-arrow--prev {
    left: 1rem;
  }

  .photo-gallery__lightbox-arrow--next {
    right: 1rem;
  }

  @media screen and (min-width: 750px) {
    .photo-gallery__lightbox-arrow--prev {
      left: 2rem;
    }

    .photo-gallery__lightbox-arrow--next {
      right: 2rem;
    }
  }

  /* Main image area */
  .photo-gallery__lightbox-main {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1 1 auto;
    width: 100%;
    max-height: calc(100vh - 120px);
    padding: 3.5rem 3.5rem 1rem;
    box-sizing: border-box;
  }

  @media screen and (min-width: 750px) {
    .photo-gallery__lightbox-main {
      padding: 3.5rem 5rem 1rem;
    }
  }

  .photo-gallery__lightbox-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    user-select: none;
    -webkit-user-drag: none;
  }

  /* Thumbnail strip */
  .photo-gallery__lightbox-thumbs {
    position: relative;
    z-index: 2;
    width: 100%;
    flex: 0 0 auto;
    padding: 0.75rem 1rem 1.25rem;
    box-sizing: border-box;
  }

  .photo-gallery__lightbox-thumbs-track {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    justify-content: center;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .photo-gallery__lightbox-thumbs-track::-webkit-scrollbar {
    display: none;
  }

  .photo-gallery__lightbox-thumb {
    flex: 0 0 auto;
    width: 60px;
    height: 44px;
    padding: 0;
    border: 2px solid transparent;
    border-radius: 4px;
    background: none;
    cursor: pointer;
    overflow: hidden;
    opacity: 0.45;
    transition: opacity 0.2s ease, border-color 0.2s ease;
  }

  .photo-gallery__lightbox-thumb:hover {
    opacity: 0.8;
  }

  .photo-gallery__lightbox-thumb--active {
    opacity: 1;
    border-color: rgba(255, 255, 255, 0.8);
  }

  .photo-gallery__lightbox-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @media screen and (min-width: 750px) {
    .photo-gallery__lightbox-thumb {
      width: 72px;
      height: 52px;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Photo Gallery",
  "tag": "section",
  "class": "section-photo-gallery",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_slideshow",
      "label": "Enable slideshow lightbox",
      "default": true,
      "info": "Clicking a gallery image opens a fullscreen slideshow"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Photo Gallery"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading/Description",
      "default": "Captured moments from our desert trips and scenic routes."
    },
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Grid Gap",
      "min": 10,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "header",
      "content": "Card height"
    },
    {
      "type": "range",
      "id": "card_height",
      "label": "Card height (desktop)",
      "min": 200,
      "max": 600,
      "step": 20,
      "unit": "px",
      "default": 360
    },
    {
      "type": "range",
      "id": "card_height_mobile",
      "label": "Card height (mobile)",
      "min": 160,
      "max": 400,
      "step": 20,
      "unit": "px",
      "default": 280
    },
    {
      "type": "header",
      "content": "Custom links (below grid)"
    },
    {
      "type": "text",
      "id": "left_link_text",
      "label": "Left link text",
      "default": "View more"
    },
    {
      "type": "url",
      "id": "left_link_url",
      "label": "Left link URL"
    },
    {
      "type": "text",
      "id": "right_link_text",
      "label": "Right link text",
      "default": "Contact"
    },
    {
      "type": "url",
      "id": "right_link_url",
      "label": "Right link URL"
    }
  ],
  "blocks": [
    {
      "type": "image_block",
      "name": "Gallery Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "select",
          "id": "size",
          "label": "Size",
          "options": [
            { "value": "standard", "label": "Standard" },
            { "value": "large", "label": "Large (spans 2 columns)" },
            { "value": "double", "label": "Double (spans 2 columns & 2 rows)" }
          ],
          "default": "standard",
          "info": "Controls the image size within the grid"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Image Link (Optional)"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt Text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Photo Gallery",
      "category": "Image"
    }
  ]
}
{% endschema %}
