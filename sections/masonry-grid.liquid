{%- comment -%}
  Masonry Grid Section
  A flexible grid with cards that can be full width or half width
  Supports collection selectors and custom links with overlaid titles
{%- endcomment -%}

{%- liquid
  assign section_id = section.id
  assign gap = section.settings.gap
  assign card_height = section.settings.card_height
  assign card_height_mobile = section.settings.card_height_mobile
  assign title_position_horizontal = section.settings.title_position_horizontal
  assign title_position_vertical = section.settings.title_position_vertical
-%}

<section
  id="MasonryGrid-{{ section_id }}"
  class="masonry-grid"
  style="
    --masonry-gap: {{ gap }}px;
    --masonry-card-height: {{ card_height }}px;
    --masonry-card-height-mobile: {{ card_height_mobile }}px;
    --padding-block-start: {{ section.settings.padding_top }}px;
    --padding-block-end: {{ section.settings.padding_bottom }}px;
  "
>
  {%- if section.settings.heading != blank -%}
    <header class="masonry-grid__header">
      <h2 class="masonry-grid__heading">{{ section.settings.heading }}</h2>
      {%- if section.settings.description != blank -%}
        <p class="masonry-grid__description">{{ section.settings.description }}</p>
      {%- endif -%}
    </header>
  {%- endif -%}

  <div class="masonry-grid__container">
    {%- for block in section.blocks -%}
      {%- liquid
        assign card_width = block.settings.card_width
        assign card_class = 'masonry-grid__card'
        if card_width == 'full'
          assign card_class = card_class | append: ' masonry-grid__card--full'
        else
          assign card_class = card_class | append: ' masonry-grid__card--half'
        endif
      -%}

      {%- case block.type -%}
        {%- when 'collection' -%}
          {%- liquid
            assign collection = block.settings.collection
            assign card_image = block.settings.image | default: collection.image | default: collection.products.first.featured_image
            assign card_title = block.settings.custom_title | default: collection.title | default: 'Collection'
            assign card_link = collection.url | default: '#'
          -%}

          <a
            href="{{ card_link }}"
            class="{{ card_class }}"
            {{ block.shopify_attributes }}
          >
            <div class="masonry-grid__card-image">
              {%- if card_image != blank -%}
                <img
                  src="{{ card_image | image_url: width: 1200 }}"
                  srcset="
                    {{ card_image | image_url: width: 600 }} 600w,
                    {{ card_image | image_url: width: 900 }} 900w,
                    {{ card_image | image_url: width: 1200 }} 1200w,
                    {{ card_image | image_url: width: 1600 }} 1600w
                  "
                  sizes="(max-width: 749px) 100vw, {{ card_width | replace: 'half', '50vw' | replace: 'full', '100vw' }}"
                  alt="{{ card_image.alt | default: card_title | escape }}"
                  loading="lazy"
                  width="{{ card_image.width }}"
                  height="{{ card_image.height }}"
                >
              {%- else -%}
                {{ 'collection-1' | placeholder_svg_tag: 'masonry-grid__placeholder' }}
              {%- endif -%}
            </div>
            <div class="masonry-grid__card-overlay"></div>
            <div class="masonry-grid__card-content masonry-grid__card-content--h-{{ title_position_horizontal }} masonry-grid__card-content--v-{{ title_position_vertical }}">
              <span class="masonry-grid__card-title">{{ card_title }}</span>
              {%- if block.settings.show_product_count and collection != blank -%}
                <span class="masonry-grid__card-count">{{ collection.products_count }} {{ 'collections.general.items' | t }}</span>
              {%- endif -%}
            </div>
          </a>

        {%- when 'custom_link' -%}
          {%- liquid
            assign card_image = block.settings.image
            assign card_title = block.settings.title | default: 'Link'
            assign card_link = block.settings.url | default: '#'
            assign open_new_tab = block.settings.open_new_tab
          -%}

          <a
            href="{{ card_link }}"
            class="{{ card_class }}"
            {% if open_new_tab %}target="_blank" rel="noopener noreferrer"{% endif %}
            {{ block.shopify_attributes }}
          >
            <div class="masonry-grid__card-image">
              {%- if card_image != blank -%}
                <img
                  src="{{ card_image | image_url: width: 1200 }}"
                  srcset="
                    {{ card_image | image_url: width: 600 }} 600w,
                    {{ card_image | image_url: width: 900 }} 900w,
                    {{ card_image | image_url: width: 1200 }} 1200w,
                    {{ card_image | image_url: width: 1600 }} 1600w
                  "
                  sizes="(max-width: 749px) 100vw, {{ card_width | replace: 'half', '50vw' | replace: 'full', '100vw' }}"
                  alt="{{ card_image.alt | default: card_title | escape }}"
                  loading="lazy"
                  width="{{ card_image.width }}"
                  height="{{ card_image.height }}"
                >
              {%- else -%}
                {{ 'collection-1' | placeholder_svg_tag: 'masonry-grid__placeholder' }}
              {%- endif -%}
            </div>
            <div class="masonry-grid__card-overlay"></div>
            <div class="masonry-grid__card-content masonry-grid__card-content--h-{{ title_position_horizontal }} masonry-grid__card-content--v-{{ title_position_vertical }}">
              <span class="masonry-grid__card-title">{{ card_title }}</span>
              {%- if block.settings.subtitle != blank -%}
                <span class="masonry-grid__card-subtitle">{{ block.settings.subtitle }}</span>
              {%- endif -%}
            </div>
          </a>
      {%- endcase -%}
    {%- else -%}
      {%- comment -%} Placeholder cards when no blocks are added {%- endcomment -%}
      {%- for i in (1..4) -%}
        <div class="masonry-grid__card masonry-grid__card--{% cycle 'half', 'half', 'full', 'half' %} masonry-grid__card--placeholder">
          <div class="masonry-grid__card-image">
            {{ 'collection-1' | placeholder_svg_tag: 'masonry-grid__placeholder' }}
          </div>
          <div class="masonry-grid__card-overlay"></div>
          <div class="masonry-grid__card-content masonry-grid__card-content--h-{{ title_position_horizontal }} masonry-grid__card-content--v-{{ title_position_vertical }}">
            <span class="masonry-grid__card-title">Card {{ i }}</span>
          </div>
        </div>
      {%- endfor -%}
    {%- endfor -%}
  </div>
</section>

{% stylesheet %}
  .masonry-grid {
    padding: var(--padding-block-start, 3rem) 1rem var(--padding-block-end, 3rem);
    background-color: var(--color-background, #fff);
  }

  @media screen and (min-width: 750px) {
    .masonry-grid {
      padding-inline: 2rem;
    }
  }

  @media screen and (min-width: 990px) {
    .masonry-grid {
      padding-inline: 3rem;
    }
  }

  .masonry-grid__header {
    text-align: center;
    margin-bottom: 2rem;
    max-width: 800px;
    margin-inline: auto;
  }

  @media screen and (min-width: 750px) {
    .masonry-grid__header {
      margin-bottom: 3rem;
    }
  }

  .masonry-grid__heading {
    font-family: var(--font-heading-family);
    font-size: var(--section-heading-md);
    font-weight: var(--font-heading-weight, 400);
    line-height: 1.2;
    margin: 0 0 0.75rem;
    color: var(--color-foreground);
  }

  @media screen and (min-width: 750px) {
    .masonry-grid__heading {
      font-size: var(--section-heading-md-desktop);
    }
  }

  .masonry-grid__description {
    font-family: var(--font-body-family);
    font-size: 1rem;
    line-height: 1.6;
    margin: 0;
    color: var(--color-foreground);
    opacity: 0.8;
  }

  .masonry-grid__container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--masonry-gap, 16px);
    max-width: 1600px;
    margin: 0 auto;
  }

  .masonry-grid__card {
    position: relative;
    display: block;
    height: var(--masonry-card-height-mobile, 300px);
    overflow: hidden;
    text-decoration: none;
    color: #fff;
    flex-shrink: 0;
  }

  /* Full width card */
  .masonry-grid__card--full {
    width: 100%;
  }

  /* Half width card */
  .masonry-grid__card--half {
    width: 100%;
  }

  @media screen and (min-width: 750px) {
    .masonry-grid__card {
      height: var(--masonry-card-height, 450px);
    }

    .masonry-grid__card--half {
      width: calc(50% - var(--masonry-gap, 16px) / 2);
    }
  }

  .masonry-grid__card-image {
    position: absolute;
    inset: 0;
  }

  .masonry-grid__card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .masonry-grid__card:hover .masonry-grid__card-image img {
    transform: scale(1.05);
  }

  .masonry-grid__placeholder {
    width: 100%;
    height: 100%;
    object-fit: cover;
    fill: #666;
    background-color: #e8e8e8;
  }

  .masonry-grid__card-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      180deg,
      rgba(0, 0, 0, 0.05) 0%,
      rgba(0, 0, 0, 0.35) 100%
    );
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .masonry-grid__card:hover .masonry-grid__card-overlay {
    opacity: 0.85;
  }

  .masonry-grid__card-content {
    position: absolute;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    padding: 1.25rem;
    z-index: 1;
    max-width: 80%;
  }

  /* Horizontal positioning */
  .masonry-grid__card-content--h-left {
    left: 0;
    align-items: flex-start;
    text-align: left;
  }

  .masonry-grid__card-content--h-center {
    left: 50%;
    transform: translateX(-50%);
    align-items: center;
    text-align: center;
  }

  .masonry-grid__card-content--h-right {
    right: 0;
    align-items: flex-end;
    text-align: right;
  }

  /* Vertical positioning */
  .masonry-grid__card-content--v-top {
    top: 0;
  }

  .masonry-grid__card-content--v-center {
    top: 50%;
    transform: translateY(-50%);
  }

  .masonry-grid__card-content--h-center.masonry-grid__card-content--v-center {
    transform: translate(-50%, -50%);
  }

  .masonry-grid__card-content--v-bottom {
    bottom: 0;
  }

  @media screen and (min-width: 750px) {
    .masonry-grid__card-content {
      padding: 1.75rem;
    }
  }

  .masonry-grid__card-title {
    font-family: var(--font-heading-family);
    font-size: 1.125rem;
    font-weight: 400;
    line-height: 1.3;
    color: #fff;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.01em;
  }

  @media screen and (min-width: 750px) {
    .masonry-grid__card-title {
      font-size: 1.375rem;
    }
  }

  @media screen and (min-width: 990px) {
    .masonry-grid__card-title {
      font-size: 1.625rem;
    }
  }

  .masonry-grid__card-subtitle,
  .masonry-grid__card-count {
    font-family: var(--font-body-family);
    font-size: 0.75rem;
    font-weight: 400;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    opacity: 0.85;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Masonry grid",
  "tag": "section",
  "class": "section-masonry-grid",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "header",
      "content": "Card layout"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap between cards",
      "min": 0,
      "max": 48,
      "step": 4,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "card_height",
      "label": "Card height (desktop)",
      "min": 250,
      "max": 700,
      "step": 25,
      "unit": "px",
      "default": 450
    },
    {
      "type": "range",
      "id": "card_height_mobile",
      "label": "Card height (mobile)",
      "min": 200,
      "max": 500,
      "step": 25,
      "unit": "px",
      "default": 300
    },
    {
      "type": "header",
      "content": "Title position"
    },
    {
      "type": "select",
      "id": "title_position_horizontal",
      "label": "Horizontal alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "select",
      "id": "title_position_vertical",
      "label": "Vertical alignment",
      "options": [
        { "value": "top", "label": "Top" },
        { "value": "center", "label": "Center" },
        { "value": "bottom", "label": "Bottom" }
      ],
      "default": "bottom"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 48
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Custom image",
          "info": "Overrides the collection image"
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Custom title",
          "info": "Overrides the collection title"
        },
        {
          "type": "checkbox",
          "id": "show_product_count",
          "label": "Show product count",
          "default": false
        },
        {
          "type": "header",
          "content": "Card size"
        },
        {
          "type": "select",
          "id": "card_width",
          "label": "Card width",
          "options": [
            { "value": "half", "label": "Half (50%)" },
            { "value": "full", "label": "Full (100%)" }
          ],
          "default": "half"
        }
      ]
    },
    {
      "type": "custom_link",
      "name": "Custom link",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Custom link"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle"
        },
        {
          "type": "url",
          "id": "url",
          "label": "Link"
        },
        {
          "type": "checkbox",
          "id": "open_new_tab",
          "label": "Open in new tab",
          "default": false
        },
        {
          "type": "header",
          "content": "Card size"
        },
        {
          "type": "select",
          "id": "card_width",
          "label": "Card width",
          "options": [
            { "value": "half", "label": "Half (50%)" },
            { "value": "full", "label": "Full (100%)" }
          ],
          "default": "half"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Masonry grid",
      "blocks": [
        { "type": "collection", "settings": { "card_width": "half" } },
        { "type": "collection", "settings": { "card_width": "half" } },
        { "type": "custom_link", "settings": { "card_width": "full", "title": "View All" } },
        { "type": "collection", "settings": { "card_width": "half" } }
      ]
    }
  ]
}
{% endschema %}

