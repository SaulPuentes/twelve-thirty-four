{%- doc -%}
  Renders a quick add component for adding products to cart from collection pages.

  @param {object} product - The product object
  @param {string} section_id - The section ID
  @param {object} [block] - The block object
  @param {string} [color_scheme] - The color scheme to use
{%- enddoc -%}

{%- liquid
  assign product_form_id = 'QuickAdd-ProductForm-' | append: product.id | append: '-' | append: section_id
  assign add_to_cart_text = 'actions.add_to_cart' | t | default: 'Add'
  assign choose_options_text = 'actions.choose_options' | t | default: 'Options'
  assign color_scheme = color_scheme | default: settings.quick_add_color_scheme

  # Logic to determine which variant to use
  assign variant = product.selected_or_first_available_variant

  if variant.available
    assign can_add_to_cart = true
  else
    assign can_add_to_cart = false
  endif

  assign quick_add_button = 'choose'
  if product.variants_count == 1 or product.options.size == 1 and product.selected_variant
    assign quick_add_button = 'add'
  endif
-%}

<quick-add-component
  class="quick-add"
  ref="quickAdd"
  data-product-title="{{ product.title }}"
  data-quick-add-button="{{ quick_add_button }}"
  data-product-options-count="{{ product.options.size }}"
>
  <product-form-component
    data-section-id="{{ section_id }}"
    data-product-id="{{ product.id }}"
    on:submit="/handleSubmit"
    class="quick-add__product-form-component"
  >
    <div
      class="visually-hidden"
      aria-live="assertive"
      role="status"
      aria-atomic="true"
      ref="liveRegion"
    ></div>
    {%- form 'product', product, id: product_form_id, novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
      <input
        type="hidden"
        name="id"
        ref="variantId"
        value="{{ variant.id }}"
        {% if variant.available == false %}
          disabled
        {% endif %}
      >
      <input
        type="hidden"
        name="quantity"
        value="{% if variant.quantity_rule.min %}{{ variant.quantity_rule.min }}{% else %}1{% endif %}"
      >
      
      {%- comment -%} Add button - for single variant products {%- endcomment -%}
      {%- render 'add-to-cart-button',
        add_to_cart_text: add_to_cart_text,
        class: 'button quick-add__button quick-add__button--add add-to-cart-button',
        can_add_to_cart: can_add_to_cart,
        icon_only_on_mobile: true,
        product: product
      -%}

      {%- comment -%} Choose button - for multi-variant products {%- endcomment -%}
      <button
        class="button quick-add__button quick-add__button--choose add-to-cart-button"
        type="button"
        name="add"
        on:click="quick-add-component/handleClick"
      >
        <span class="add-to-cart-text quick-add__button-content">
          <span
            aria-hidden="true"
            class="svg-wrapper add-to-cart-icon quick-add__button-icon"
          >
            {%- render 'icon', icon: 'cart', size: 20 -%}
          </span>
          <span class="add-to-cart-text__content is-visually-hidden-mobile quick-add__button-text">
            <span>
              <span>{{ choose_options_text }}</span>
            </span>
          </span>
        </span>
      </button>
    {%- endform -%}
  </product-form-component>
</quick-add-component>

{% stylesheet %}
  /* Quick Add Component */
  .quick-add {
    --quick-add-offset: 0.75rem;
    
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
  }

  .quick-add__product-form-component {
    height: 100%;
  }

  .quick-add__product-form-component .shopify-product-form {
    display: flex;
    justify-content: flex-end;
    align-items: flex-end;
    height: 100%;
  }

  /* Quick Add Button */
  .quick-add__button {
    display: none;
    align-items: center;
    justify-content: center;
    background-color: var(--color-background, #fff);
    padding: 0;
    border-radius: 50px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    height: 40px;
    min-width: 40px;
    cursor: pointer;
    opacity: 0;
    overflow: hidden;
    color: var(--color-foreground, #000);
    pointer-events: all;
    position: absolute;
    right: var(--quick-add-offset);
    bottom: var(--quick-add-offset);
    transition: opacity 0.3s ease, transform 0.2s ease;
  }

  .quick-add__button:hover {
    transform: scale(1.05);
  }

  .quick-add__button:active {
    transform: scale(0.98);
  }

  /* Show on hover */
  .main-collection__grid-item:hover .quick-add__button,
  .main-collection__grid-item:focus-within .quick-add__button {
    opacity: 1;
  }

  @media screen and (min-width: 750px) {
    .quick-add__button {
      display: flex;
    }
  }

  /* Button variants based on data attribute */
  [data-quick-add-button="add"] .quick-add__button--add {
    display: flex;
  }

  [data-quick-add-button="add"] .quick-add__button--choose {
    display: none;
  }

  [data-quick-add-button="choose"] .quick-add__button--add {
    display: none;
  }

  [data-quick-add-button="choose"] .quick-add__button--choose {
    display: flex;
  }

  /* Button content */
  .quick-add__button .add-to-cart-text {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    justify-content: center;
    padding: 0 0.75rem;
  }

  .quick-add__button .add-to-cart-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
  }

  .quick-add__button .add-to-cart-text__content {
    display: none;
  }

  @media screen and (min-width: 990px) {
    .quick-add__button:hover .add-to-cart-text__content {
      display: inline;
    }
  }

  /* Visually hidden on mobile */
  .is-visually-hidden-mobile {
    @media screen and (max-width: 749px) {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  }
{% endstylesheet %}
